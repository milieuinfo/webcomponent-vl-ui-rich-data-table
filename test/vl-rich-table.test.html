<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <script src="../../@webcomponents/webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../web-component-tester/browser.js"></script>

  <script type="module" src="../vl-rich-table.js"></script>
</head>

<body>

<test-fixture id="vl-rich-table-fixture">
  <template>
    <vl-rich-table>
      <vl-rich-table-field data-value="test" label="Test"></vl-rich-table-field>
    </vl-rich-table>
  </template>
</test-fixture>

<test-fixture id="vl-rich-table-fixture-zebra-lined-hover">
  <template>
    <vl-rich-table zebra lined hover>
      <vl-rich-table-field data-value="test" label="Test"></vl-rich-table-field>
    </vl-rich-table>
  </template>
</test-fixture>

<test-fixture id="vl-rich-table-data-fixture">
  <template>
    <vl-rich-table data='[{"test": "Dit is testdata."}]'>
      <vl-rich-table-field data-value="test" label="Test"></vl-rich-table-field>
    </vl-rich-table>
  </template>
</test-fixture>

<test-fixture id="vl-rich-table-data-type-fixture">
  <template>
    <vl-rich-table data='[{"tekst": "Dit is testdata.", "datum": "2012-04-03", "tijdstip": "2012-04-03T18:05:43.511" }]'>
      <vl-rich-table-field data-value="tekst" data-type="string" label="Tekst"></vl-rich-table-field>
      <vl-rich-table-field data-value="datum" data-type="date" label="Datum"></vl-rich-table-field>
      <vl-rich-table-field data-value="tijdstip" data-type="datetime" label="Tijdstip"></vl-rich-table-field>
    </vl-rich-table>
  </template>
</test-fixture>

<test-fixture id="vl-rich-table-pager-fixture">
  <template>
    <vl-rich-table>
      <vl-rich-table-field sortable data-value="name" label="Naam"></vl-rich-table-field>
      <vl-rich-table-pager align-right total-items="100" items-per-page="10" current-page="1"></vl-rich-table-pager>
    </vl-rich-table>
  </template>
</test-fixture>

<test-fixture id="vl-rich-table-pager-met-data-in-object-formaat-fixture">
  <template>
    <vl-rich-table data='{"content":[
        {"id": 1, "name": "Lorem ipsum", "description": "Lorem ipsum dolor sit amet, consectetur adipisicing elit."},
        {"id": 2, "name": "Amet aut", "description": "Amet aut, blanditiis dignissimos, earum et eveniet explicabo in labore minus odio odit optio, perferendis provident quas quis quod totam vel vero."},
        {"id": 3, "name": "Lorem ipsum", "description": "Amet aut, blanditiis dignissimos"}
        ],"totalElements":20,"size":2,"number":3}'>
      <vl-rich-table-field sortable data-value="name" label="Naam"></vl-rich-table-field>
      <vl-rich-table-pager align-right></vl-rich-table-pager>
    </vl-rich-table>
  </template>
</test-fixture>

<test-fixture id="vl-rich-table-sortable-fixture">
  <template>
    <vl-rich-table>
      <vl-rich-table-field sortable data-value="name" label="Naam"></vl-rich-table-field>
      <vl-rich-table-field sortable data-value="description" label="Omschrijving"></vl-rich-table-field>
    </vl-rich-table>
  </template>
</test-fixture>

<test-fixture id="vl-rich-table-sortable-met-default-waard-fixture">
  <template>
    <vl-rich-table>
      <vl-rich-table-field sortable direction="desc" priority="2" data-value="name" label="Naam"></vl-rich-table-field>
      <vl-rich-table-field sortable direction="asc" priority="1" data-value="description" label="Omschrijving"></vl-rich-table-field>
    </vl-rich-table>
  </template>
</test-fixture>

<test-fixture id="vl-rich-table-met-filter">
  <template>
    <vl-rich-table>
      <vl-rich-table-field sortable direction="desc" priority="2" data-value="name" label="Naam"></vl-rich-table-field>
      <vl-rich-table-field sortable direction="asc" priority="1" data-value="description" label="Omschrijving"></vl-rich-table-field>
      <div slot="filter">
        <input name="name" placeholder="Zoeken op naam..." data-vl-search-criterium="name"/>
        <select data-vl-search-criterium="description">
          <option value="" placeholder></option>
          <option value="t1">Test1</option>
          <option value="t2">Test2</option>
        </select>
      </div>
    </vl-rich-table>
  </template>
</test-fixture>

<test-fixture id="vl-rich-table-met-number-filter">
  <template>
    <vl-rich-table>
      <vl-rich-table-field data-value="number" label="Nummer"></vl-rich-table-field>
      <div slot="filter">
        <input name="name" type="number" placeholder="Zoeken op nummer..." data-vl-search-criterium="number"/>
      </div>
    </vl-rich-table>
  </template>
</test-fixture>

<script type="module">
  import {awaitUntil} from "vl-ui-core/vl-core.src";

  const getNameColumn = (table) => {
    return table.querySelector("vl-rich-table-field[data-value='name']");
  };

  const getDescriptionColumn = (table) => {
    return table.querySelector("vl-rich-table-field[data-value='description']");
  };

  const getNameColumnSortButton = (table) => {
    return  table.shadowRoot.querySelectorAll('table > thead > tr >th >span[name="sortable-span"]')[0];
  };

  const getDescriptionColumnSortButton = (table) => {
    return  table.shadowRoot.querySelectorAll('table > thead > tr >th >span[name="sortable-span"]')[1];
  };

  const getIconOfNameFieldHeader = (table) => {
    return table.shadowRoot.querySelectorAll("table > thead > tr >th >span[name='sortable-span']")[0].getAttribute('icon');
  };

  const getIconOfDescriptionFieldHeader = (table) => {
    return table.shadowRoot.querySelectorAll("table > thead > tr >th >span[name='sortable-span']")[1].getAttribute('icon');
  };

  suite('vl-rich-table', () => {
    const should = chai.should();

    test('met een vl-rich-table-field wordt een table header cell gemaakt', () => {
      const table = fixture('vl-rich-table-fixture');

      assert.isNotNull(table.shadowRoot.querySelector("table > thead > tr > th"));
      assert.equal(table.shadowRoot.querySelector("table > thead > tr > th").textContent, 'Test');
    });

    test('als zebra lined of hover op de vl-rich-table staat, staat die ook op vl-data-table', () => {
      const richTable = fixture('vl-rich-table-fixture-zebra-lined-hover');

      assert.equal(richTable._table.getAttribute('zebra'), '');
      assert.equal(richTable._table.getAttribute('lined'), '');
      assert.equal(richTable._table.getAttribute('hover'), '');
    });

    test('bij het toevoegen van data in "array" formaat,wordt een rij gemaakt met de data op basis van de data-value van de field', () => {
      const table = fixture('vl-rich-table-fixture');

      table.data = [{test: "Dit is testdata."}];

      assert.isNotNull(table.shadowRoot.querySelector("table > tbody > tr > td"));
      assert.equal(table.shadowRoot.querySelector("table > tbody > tr > td").textContent, 'Dit is testdata.');
    });

    test('bij het toevoegen van data in "object" formaat,wordt een rij gemaakt met de data op basis van de data-value van de field en triggert ' +
        'een "data_update_from_object" event'
        , (done) => {
          const table = fixture('vl-rich-table-fixture');
          table.addEventListener('data_update_from_object', (e) => {
            assert.isNotNull(table.shadowRoot.querySelector("table > tbody > tr > td"));
            assert.equal(table.shadowRoot.querySelector("table > tbody > tr > td").textContent, 'Dit is testdata.');
            done();
          });

          table.data = {content: [{test: "Dit is testdata."}]};
        });

    test('bij het toevoegen van ongeldige data is er een fout', () => {
      const table = fixture('vl-rich-table-fixture');
      assert.throws(() => table.data = "invalid", Error, "geen geldige array");
      table.data = [];
    });

    test('bij het toevoegen van data wordt deze getoond volgens het gedefinieerde data type', async () => {
      const table = fixture('vl-rich-table-data-type-fixture');

      await flush(() => {
      });
      const tds = [...table.shadowRoot.querySelectorAll("table > tbody > tr > td")];
      assert.equal(tds[0].textContent, 'Dit is testdata.');
      assert.equal(tds[1].textContent, '03.04.2012');
      assert.equal(tds[2].textContent, '03.04.2012 18:05:43');
    });

    test('bij het toevoegen van data met verkeerd datum en tijd datatype verschijnt Invalid Date', async () => {
      const table = fixture('vl-rich-table-data-type-fixture');
      table.data = [{"tekst": "0", "datum": "abc", "tijdstip": "def"}];
      await flush(() => {
      });
      const tds = [...table.shadowRoot.querySelectorAll("table > tbody > tr > td")];
      assert.equal(tds[0].textContent, '0');
      assert.equal(tds[1].textContent, 'Invalid Date');
      assert.equal(tds[2].textContent, 'Invalid Date');
    });

    test('na het veranderen van de render functie zal die gebruikt worden om data te renderen', () => {
      const table = fixture('vl-rich-table-fixture');

      table.children[0].renderTableData = function (content) {
        const div = document.createElement("div");
        div.innerHTML = "<strong>" + content + "</strong>";
        return div;
      };
      table.data = [{test: "Dit is testdata."}];

      assert.isNotNull(table.shadowRoot.querySelector("table > tbody > tr > td > div > strong"));
      assert.equal(table.shadowRoot.querySelector("table > tbody > tr > td > div > strong").textContent, 'Dit is testdata.');
    });

    test('bij voorgedefinieerde data zal de tabel inhoud de testdata bevatten', async () => {
      const table = fixture('vl-rich-table-data-fixture');

      await flush(() => {
      });

      assert.isNotNull(table.shadowRoot.querySelector("table > tbody > tr > td"));
      assert.equal(table.shadowRoot.querySelector("table > tbody > tr > td").textContent, 'Dit is testdata.');
    });

    test('bij het wijzigen van data via het attribuut zal de tabel inhoud ook veranderen', () => {
      const table = fixture('vl-rich-table-data-fixture');

      table.setAttribute('data', '[{"test": "Dit is andere data."}]');

      assert.isNotNull(table.shadowRoot.querySelector("table > tbody > tr > td"));
      assert.equal(table.shadowRoot.querySelector("table > tbody > tr > td").textContent, 'Dit is andere data.');
    });

    test('pager wordt in de footer-caption toegevoegd', () => {
      const table = fixture('vl-rich-table-pager-fixture');
      assert.isNotNull(table.shadowRoot.querySelector("table >caption >vl-rich-table-pager"));
    });

    test('kunnen de pager initialen door de juiste json input', (done) => {
      const table = fixture('vl-rich-table-pager-met-data-in-object-formaat-fixture');
      const pager = table.shadowRoot.querySelector("vl-rich-table-pager");
      flush(() => {
        assert.equal(pager.getAttribute('total-items'), "20");
        assert.equal(pager.getAttribute('items-per-page'), "2");
        assert.equal(pager.getAttribute('current-page'), "4");
        done();
      });
    });

    test('pager triggert en "pagechanged" event', (done) => {
      const table = fixture('vl-rich-table-pager-fixture');
      const pager = table.shadowRoot.querySelector("vl-rich-table-pager");
      table.addEventListener('pagechanged', (e) => {
        assert.equal(e.detail.newPage, 2);
        done();
      });
      pager.setAttribute('current-page', 2)
    });

    test('de sortable kolom header heeft de juiste style', (done) => {
      const table = fixture('vl-rich-table-sortable-fixture');
      flush(() => {
        assert.equal(table.shadowRoot.querySelectorAll("table > thead > tr >th").length, 2);
        assert.equal(table.shadowRoot.querySelectorAll("table > thead > tr >th >span[icon='sort']").length, 2);
        assert.equal(table.shadowRoot.querySelectorAll("table > thead > tr >th")[0].textContent, "Naam");
        assert.equal(table.shadowRoot.querySelectorAll("table > thead > tr >th")[1].textContent, "Omschrijving");
        done();
      });
    });

    test('klik op de  sorteren icon triggert "pagechanged" event en de icon verandert volgens volgende volgorde:"down","up" en "none"', (done) => {
      const table = fixture('vl-rich-table-sortable-fixture');
      const column1 = getNameColumnSortButton(table);
      let i = 0;
      table.addEventListener('sort', (e) => {
        i++;
      });
      column1.click();

      awaitUntil(() => i === 1).then(() => {
        assert.equal(getIconOfNameFieldHeader(table), 'nav-down');
        assert.equal(table.sortCriteria[0].name, 'name');
        assert.equal(table.sortCriteria[0].direction, 'desc');
        column1.click();
      });

      awaitUntil(() => i === 2).then(() => {
        assert.equal(getIconOfNameFieldHeader(table), 'nav-up');
        assert.equal(table.sortCriteria[0].name, 'name');
        assert.equal(table.sortCriteria[0].direction, 'asc');
        column1.click();
      });

      awaitUntil(() => i === 3).then(() => {
        assert.equal(getIconOfNameFieldHeader(table), 'sort');
        assert.equal(table.sortCriteria.length, 0);
        column1.click();
      });

      awaitUntil(() => i === 4).then(() => {
        assert.equal(getIconOfNameFieldHeader(table), 'nav-down');
        assert.equal(table.sortCriteria[0].name, 'name');
        assert.equal(table.sortCriteria[0].direction, 'desc');
        done();
      });
    });

    test('de laaste geklikt kolom krijgt de laagste prioriteit', (done) => {
      const table = fixture('vl-rich-table-sortable-fixture');
      const column1 = getNameColumnSortButton(table);
      const column2 = getDescriptionColumnSortButton(table);
      let i = 0;

      table.addEventListener('sort', (e) => {
        i++;
      });
      column1.click();

      awaitUntil(() => i === 1).then(() => {
        assert.equal(table.sortCriteria.length, 1);

        assert.equal(table.shadowRoot.querySelectorAll("table > thead > tr >th >span[name='sortable-span']")[0].getAttribute('icon'), 'nav-down');
        assert.equal(table.sortCriteria[0].name, 'name');
        assert.equal(table.sortCriteria[0].direction, 'desc');

        assert.equal(table.shadowRoot.querySelectorAll("table > thead > tr >th >span[name='sortable-span']")[1].getAttribute('icon'), 'sort');
        column2.click();
      });

      awaitUntil(() => i === 2).then(() => {
        assert.equal(table.sortCriteria.length, 2);

        assert.equal(table.shadowRoot.querySelectorAll("table > thead > tr >th >span[name='sortable-span']")[0].getAttribute('icon'), 'nav-down');
        assert.equal(table.sortCriteria[0].name, 'name');
        assert.equal(table.sortCriteria[0].direction, 'desc');

        assert.equal(table.shadowRoot.querySelectorAll("table > thead > tr >th >span[name='sortable-span']")[1].getAttribute('icon'), 'nav-down');
        assert.equal(table.sortCriteria[1].name, 'description');
        assert.equal(table.sortCriteria[1].direction, 'desc');
        column1.click();
      });

      awaitUntil(() => i === 3).then(() => {
        assert.equal(table.sortCriteria.length, 2);

        assert.equal(table.shadowRoot.querySelectorAll("table > thead > tr >th >span[name='sortable-span']")[0].getAttribute('icon'), 'nav-up');
        assert.equal(table.sortCriteria[1].name, 'name');
        assert.equal(table.sortCriteria[1].direction, 'asc');

        assert.equal(table.shadowRoot.querySelectorAll("table > thead > tr >th >span[name='sortable-span']")[1].getAttribute('icon'), 'nav-down');
        assert.equal(table.sortCriteria[0].name, 'description');
        assert.equal(table.sortCriteria[0].direction, 'desc');
        column2.click();
      });

      awaitUntil(() => i === 4).then(() => {
        assert.equal(table.sortCriteria.length, 2);

        assert.equal(table.shadowRoot.querySelectorAll("table > thead > tr >th >span[name='sortable-span']")[0].getAttribute('icon'), 'nav-up');
        assert.equal(table.sortCriteria[0].name, 'name');
        assert.equal(table.sortCriteria[0].direction, 'asc');

        assert.equal(table.shadowRoot.querySelectorAll("table > thead > tr >th >span[name='sortable-span']")[1].getAttribute('icon'), 'nav-up');
        assert.equal(table.sortCriteria[1].name, 'description');
        assert.equal(table.sortCriteria[1].direction, 'asc');
        column1.click();
      });

      awaitUntil(() => i === 5).then(() => {
        assert.equal(table.sortCriteria.length, 1);

        assert.equal(table.shadowRoot.querySelectorAll("table > thead > tr >th >span[name='sortable-span']")[0].getAttribute('icon'), 'sort');

        assert.equal(table.shadowRoot.querySelectorAll("table > thead > tr >th >span[name='sortable-span']")[1].getAttribute('icon'), 'nav-up');
        assert.equal(table.sortCriteria[0].name, 'description');
        assert.equal(table.sortCriteria[0].direction, 'asc');
        column2.click();
      });

      awaitUntil(() => i === 6).then(() => {
        assert.equal(table.sortCriteria.length, 0);

        assert.equal(table.shadowRoot.querySelectorAll("table > thead > tr >th >span[name='sortable-span']")[0].getAttribute('icon'), 'sort');

        assert.equal(table.shadowRoot.querySelectorAll("table > thead > tr >th >span[name='sortable-span']")[1].getAttribute('icon'), 'sort');
        done();
      });
    });

    test('de sort criterias veranderen door de veld attributes', (done) => {
      const table = fixture('vl-rich-table-sortable-fixture');

      let nameColumn = getNameColumn(table);
      let descriptionColumn = getDescriptionColumn(table);

      nameColumn.setAttribute("direction", "asc");
      nameColumn.setAttribute("priority", "1");

      descriptionColumn.setAttribute("direction", "desc");
      descriptionColumn.setAttribute("priority", "2");

      flush(() => {
        assert.equal(table.sortCriteria.length, 2);

        assert.equal(getIconOfNameFieldHeader(table), 'nav-up');
        assert.equal(table.sortCriteria[0].name, 'name');
        assert.equal(table.sortCriteria[0].direction, 'asc');

        assert.equal(getIconOfDescriptionFieldHeader(table), 'nav-down');
        assert.equal(table.sortCriteria[1].name, 'description');
        assert.equal(table.sortCriteria[1].direction, 'desc');

        done();
      })
    });

    test('om een sort criteria te bepalen,attributes "direction" en "priority" zijn beide verplicht', (done) => {
      const table = fixture('vl-rich-table-sortable-fixture');

      let nameColumn = getNameColumn(table);
      let descriptionColumn = getDescriptionColumn(table);

      nameColumn.setAttribute("direction", "asc");
      nameColumn.setAttribute("priority", "1");

      descriptionColumn.setAttribute("direction", "desc");

      flush(() => {
        assert.equal(table.sortCriteria.length, 1);

        assert.equal(getIconOfNameFieldHeader(table), 'nav-up');
        assert.equal(table.sortCriteria[0].name, 'name');
        assert.equal(table.sortCriteria[0].direction, 'asc');

        assert.equal(getIconOfDescriptionFieldHeader(table), 'sort');
        done();
      })
    });

    test('kunnen de sort criteria bepalen door de default waarde aan te duiden', (done) => {
      const table = fixture('vl-rich-table-sortable-met-default-waard-fixture');
      flush(() => {
        assert.equal(table.sortCriteria.length, 2);

        assert.equal(getIconOfNameFieldHeader(table), 'nav-down');
        assert.equal(table.sortCriteria[1].name, 'name');
        assert.equal(table.sortCriteria[1].direction, 'desc');

        assert.equal(getIconOfDescriptionFieldHeader(table), 'nav-up');
        assert.equal(table.sortCriteria[0].name, 'description');
        assert.equal(table.sortCriteria[0].direction, 'asc');
        done();
      })
    });

    test('als de input verandert, zal er een search event uitgezonden worden met searchCriteria', (done) => {
      const table = fixture('vl-rich-table-met-filter');
      table.addEventListener('search', (e) => {
        assert.equal(Object.keys(e.detail.searchCriteria).length, 1);
        assert.equal(e.detail.searchCriteria['name'], 'search');
        done();
      });

      flush(() => {
        table.querySelector('input').value = 'search';
        table.querySelector('input').dispatchEvent(new CustomEvent('input'));
      });
    });

    test('als de input verandert naar 0, zal er een search event uitgezonden worden met searchCriteria', (done) => {
      const table = fixture('vl-rich-table-met-number-filter');
      table.addEventListener('search', (e) => {
        assert.equal(Object.keys(e.detail.searchCriteria).length, 1);
        assert.equal(e.detail.searchCriteria['number'], 0);
        done();
      });

      flush(() => {
        table.querySelector('input').value = 0;
        table.querySelector('input').dispatchEvent(new CustomEvent('input'));
      });
    });

    test('als de select verandert, zal er een search event uitgezonden worden met searchCriteria', (done) => {
      const table = fixture('vl-rich-table-met-filter');
      table.addEventListener('search', (e) => {
        assert.equal(Object.keys(e.detail.searchCriteria).length, 1);
        assert.equal(e.detail.searchCriteria['description'], 't2');
        done();
      });
      flush(() => {
        table.querySelector('select').value = 't2';
        table.querySelector('select').dispatchEvent(new Event('change'));
      });
    });

    test('als de input en select allebei veranderen, zal er een search event uitgezonden worden met searchCriteria', (done) => {
      const table = fixture('vl-rich-table-met-filter');
      table.addEventListener('search', (e) => {
        assert.equal(Object.keys(e.detail.searchCriteria).length, 2);
        assert.equal(e.detail.searchCriteria['name'], 'n2');
        assert.equal(e.detail.searchCriteria['description'], 't2');
        done();
      });

      flush(() => {
        table.querySelector('input').value = 'n2';
        table.querySelector('select').value = 't2';
        table.querySelector('select').dispatchEvent(new Event('change'));
      });
    });
  });
</script>
</body>
</html>
